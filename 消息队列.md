### 为什么会引入消息队列

做系统解耦合流量控制

- 系统解耦就是为了隔离系统上下文环境变化带来的不稳定因素。
- 流量控制就是在遇到秒杀场景下，可以实现流量的削峰填谷，根据下游的处理能力自动调节流量。



### MQ : 怎么确保消息100%不会丢失

我们要分析3个点：

1. 如何知道有消息丢失？
2. 哪些环节可能丢消息？
3. 如何确保消息不丢失？



首先来看消息丢失的环节，一条消息从生产到消费完成这个过程，可以划分三个阶段，分别为消息生产阶段，消息存储阶段和消息消费阶段。

但是这个过程存在有消息丢失的问题，如何进行消息检测呢？

 总体方案解决思路为：在消息生产端，给每个发出的消息都指定一个全局唯一 ID，或者附加一个连续递增的版本号，然后在消费端做对应的版本校验。

#### 消息检测

具体实现：

1. 利用拦截器机制。 在生产端发送消息之前，通过拦截器将消息版本号注入消息中。这里只能利用全局唯一ID来实现
2. 后在消费端收到消息后，再通过拦截器检测版本号的连续性或消费状态。

这样实现的好处是消息检测的代码不会侵入到业务代码中，可以通过单独的任务来定位丢失的消息，做进一步的排查。



#### 消息被重复消费

或者可以说是，如何解决消费端幂等问题，幂等性问题的重要一点就是实现全局唯一ID生成的技术方案。

最简单的实现方法就是：

就是在数据库中建一张消息日志表， 这个表有两个字段：消息 ID 和消息执行状态。这样，我们消费消息的逻辑可以变为：在消息日志表中增加一条消息记录，然后再根据消息记录，异步操作更新用户京豆余额。

因为我们每次都会在插入之前检查是否消息已存在，所以就不会出现一条消息被执行多次的情况，这样就实现了一个幂等的操作。



#### 消费积压

如果出现积压现象，一定是性能问题，想要解决消息从生产到消费上的性能问题，就首先要知道哪些环节可能出现消息积压，然后在考虑如何解决

1. 线上突发问题，要临时扩容，增加消费端的数量，与此同时，降级一些非核心的业务。通过扩容和降级承担流量。
2. 排查解决异常问题，如通过监控，日志等手段分析是否消费端的业务逻辑代码出现了问题，优化消费端的业务处理逻辑。
3. 如果是消费端的处理能力不足，可以通过水平扩容来提供消费端的并发处理能力